<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daily Audio News Digest</title>
  <style>
    body { font-family: Arial; background:#f5f5f5; color:#333; margin:0; padding:0; }
    header { background:#222; color:#fff; text-align:center; padding:20px; }
    main { padding:20px; }
    button { background:#007bff; color:#fff; border:none; padding:12px 18px; border-radius:5px; cursor:pointer; margin:10px 0; font-size:16px; }
    button:hover { background:#0056b3; }
  </style>
</head>
<body>

<header>
  <h1>Daily Audio News Digest</h1>
  <p>Press “Generate & Play” to hear today’s news</p>
  <button id="playButton">▶️ Generate & Play</button>
</header>

<main>
  <p id="status">Waiting for you to press the button...</p>
</main>

<script>
const introMusicList = [
  'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3',
  'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3'
];
const outroMusicList = [
  'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3',
  'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3'
];

function getRandom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

async function fetchRSS(url){
  try{
    const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
    const data = await response.json();
    const parser = new DOMParser();
    const xml = parser.parseFromString(data.contents,'text/xml');
    const items = xml.querySelectorAll('item');
    const headlines = [];
    items.forEach((item,i)=>{ if(i<5){ headlines.push(item.querySelector('title').textContent); } });
    return headlines;
  }catch(err){
    console.error(err);
    return ['Could not fetch news from this source.'];
  }
}

async function getSummary(section, headlines){
  try{
    const res = await fetch('/api/summarize', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ section, headlines })
    });
    const data = await res.json();
    return data.summary || 'Summary not available.';
  }catch(err){
    console.error(err);
    return 'Summary generation failed.';
  }
}

async function playNews(){
  const status = document.getElementById('status');
  status.innerText = 'Preparing your digest...';

  const introAudio = new Audio(getRandom(introMusicList));
  const outroAudio = new Audio(getRandom(outroMusicList));

  introAudio.play();

  introAudio.onended = async ()=>{
    status.innerText = 'Fetching headlines...';

    const feeds = {
      global:[
        'http://feeds.bbci.co.uk/news/world/rss.xml',
        'http://feeds.reuters.com/Reuters/worldNews'
      ],
      us:[
        'http://rss.cnn.com/rss/cnn_us.rss',
        'https://rss.nytimes.com/services/xml/rss/nyt/US.xml'
      ],
      colorado:[
        'https://www.denverpost.com/feed/',
        'https://coloradosun.com/feed/'
      ]
    };

    const newsData = {};

    for(const section in feeds){
      newsData[section]=[];
      for(const feed of feeds[section]){
        const headlines = await fetchRSS(feed);
        newsData[section].push(...headlines);
      }
    }

    status.innerText = 'Generating summaries...';

    const scriptSections = [];
    for(const section of ['global','us','colorado']){
      const summary = await getSummary(section, newsData[section]);
      scriptSections.push(summary);
    }

    const finalScript = `Welcome to your Daily Audio News Digest. ${scriptSections.join(' ')} That concludes today’s digest.`;

    status.innerText = 'Reading news...';
    speak(finalScript, ()=>{
      outroAudio.play();
      status.innerText = 'Digest finished!';
    });
  };
}

function speak(text, callback){
  const msg = new SpeechSynthesisUtterance(text);
  msg.rate=1;
  msg.onend=callback;
  window.speechSynthesis.speak(msg);
}

document.getElementById('playButton').addEventListener('click', playNews);
</script>

</body>
</html>
