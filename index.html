<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Daily Audio News Digest</title>
</head>
<body>
  <h1>Daily Audio News Digest</h1>
  <button onclick="playNews()">Generate & Play</button>
  <p id="status">Press the button to begin.</p>

  <script>
    // ðŸŽµ Intro and outro music pool
    const introMusicList = [
      'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3',
      'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3'
    ];
    const outroMusicList = [
      'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3',
      'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3'
    ];

    function getRandom(list) {
      return list[Math.floor(Math.random() * list.length)];
    }

    async function playNews(){
      const status = document.getElementById('status');
      status.innerText = 'Preparing your digest...';

      // ðŸŽµ Try playing intro music, but donâ€™t get stuck if it fails
      try {
        const introAudio = new Audio(getRandom(introMusicList));
        await introAudio.play();
        introAudio.onended = () => {
          startNews(); // begin after music ends
        };
      } catch (err) {
        console.warn("Intro music failed, starting news immediately:", err);
        startNews();
      }
    }

    async function startNews(){
      const status = document.getElementById('status');
      status.innerText = 'Fetching headlines...';

      const feeds = {
        global: ['http://feeds.bbci.co.uk/news/world/rss.xml'],
        us: ['http://rss.cnn.com/rss/cnn_us.rss'],
        colorado: ['https://www.denverpost.com/feed/']
      };

      const newsData = {};
      for(const section in feeds){
        newsData[section] = [];
        for(const feed of feeds[section]){
          try {
            const headlines = await fetchRSS(feed);
            newsData[section].push(...headlines);
          } catch(e){
            console.error("RSS fetch failed for", feed, e);
          }
        }
      }

      status.innerText = 'Generating summaries...';

      const scriptSections = [];
      for(const section of ['global','us','colorado']){
        try {
          const summary = await getSummary(section, newsData[section]);
          scriptSections.push(summary);
        } catch(e){
          console.error("Summary failed for", section, e);
        }
      }

      const finalScript = `Welcome to your Daily Audio News Digest. ${scriptSections.join(' ')} That concludes todayâ€™s digest.`;

      status.innerText = 'Reading news...';
      speak(finalScript, ()=>{
        try {
          const outroAudio = new Audio(getRandom(outroMusicList));
          outroAudio.play();
        } catch(err){
          console.warn("Outro music failed:", err);
        }
        status.innerText = 'Digest finished!';
      });
    }

    async function fetchRSS(url){
      const res = await fetch('https://api.allorigins.win/get?url=' + encodeURIComponent(url));
      const data = await res.json();
      const parser = new DOMParser();
      const xml = parser.parseFromString(data.contents, 'text/xml');
      const items = xml.querySelectorAll('item');
      return Array.from(items).slice(0,5).map(i=>i.querySelector('title').textContent);
    }

    async function getSummary(section, headlines){
      const res = await fetch('/api/summarize',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ section, headlines })
      });
      const data = await res.json();
      if(data.summary){
        return data.summary;
      } else {
        return `No summary available for ${section}.`;
      }
    }

    function speak(text, onEnd){
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.rate = 1.0; // normal speed (you can speed up manually on phone)
      utterance.onend = onEnd;
      speechSynthesis.speak(utterance);
    }
  </script>
</body>
</html>
