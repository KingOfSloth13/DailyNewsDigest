<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Daily Audio News Digest</title>
  <style>
    #progress {
      width: 100%;
      height: 20px;
      background: #ddd;
      border-radius: 10px;
      margin: 10px 0;
      overflow: hidden;
    }
    #bar {
      height: 100%;
      width: 0%;
      background: #4caf50;
      transition: width 0.3s ease;
    }
  </style>
</head>
<body>
  <h1>Daily Audio News Digest</h1>
  <button onclick="playNews()">Generate & Play</button>
  
  <div id="progress">
    <div id="bar"></div>
  </div>
  <p id="status">Press the button to begin.</p>

  <label for="speed">Playback speed:</label>
  <select id="speed">
    <option value="1">1x</option>
    <option value="1.5">1.5x</option>
    <option value="2">2x</option>
  </select>

  <script>
    async function playNews(){
      const status = document.getElementById('status');
      const bar = document.getElementById('bar');
      const speed = parseFloat(document.getElementById('speed').value);

      function updateProgress(percent, text){
        bar.style.width = percent + "%";
        status.innerText = text;
      }

      updateProgress(10, "Fetching headlines...");

      const feeds = {
        global: ['http://feeds.bbci.co.uk/news/world/rss.xml'],
        us: ['http://rss.cnn.com/rss/cnn_us.rss'],
        colorado: ['https://www.denverpost.com/feed/']
      };

      const newsData = {};
      for(const section in feeds){
        newsData[section] = [];
        for(const feed of feeds[section]){
          try {
            const headlines = await fetchRSS(feed);
            newsData[section].push(...headlines);
          } catch(e){
            console.error("RSS fetch failed for", feed, e);
          }
        }
      }

      updateProgress(40, "Generating summaries...");

      const scriptSections = [];
      for(const section of ['global','us','colorado']){
        try {
          const summary = await getSummary(section, newsData[section]);
          scriptSections.push(summary);
        } catch(e){
          console.error("Summary failed for", section, e);
        }
      }

      const finalScript = `Welcome to your Daily Audio News Digest. ${scriptSections.join(' ')} That concludes todayâ€™s digest.`;

      updateProgress(70, "Preparing to read...");

      speak(finalScript, speed, ()=>{
        updateProgress(100, "Digest finished!");
      });
    }

    async function fetchRSS(url){
      const res = await fetch('https://api.allorigins.win/get?url=' + encodeURIComponent(url));
      const data = await res.json();
      const parser = new DOMParser();
      const xml = parser.parseFromString(data.contents, 'text/xml');
      const items = xml.querySelectorAll('item');
      return Array.from(items).slice(0,5).map(i=>i.querySelector('title').textContent);
    }

    async function getSummary(section, headlines){
      const res = await fetch('/api/summarize',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ section, headlines })
      });
      const data = await res.json();
      if(data.error){
        console.error("API error:", data.error);
        return `Error summarizing ${section} news.`;
      }
      if(data.summary){
        return data.summary;
      }
      return `No summary available for ${section}.`;
    }

    function speak(text, rate, onEnd){
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.rate = rate;
      utterance.onend = onEnd;
      speechSynthesis.speak(utterance);
    }
  </script>
</body>
</html>
